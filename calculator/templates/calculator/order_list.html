{% extends 'calculator/base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Мои заказы</h1>
    <a href="{% url 'order_create' %}" class="btn btn-success">
        <i class="fas fa-plus"></i> Создать новый заказ
    </a>
</div>


<!-- Панель поиска и фильтров -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-white">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" 
                           class="form-control form-control-lg" 
                           name="search" 
                           value="{{ search_query }}"
                           placeholder="Поиск по номеру, наименованию или чертежу..."
                           autocomplete="off">
                    {% if search_query %}
                    <a href="{% url 'order_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Сбросить
                    </a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">
                        Найти
                    </button>
                </div>
                <div class="form-text mt-2">
                    <i class="fas fa-info-circle"></i> Можно искать по номеру заказа, наименованию или номеру чертежа
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Результаты поиска -->
{% if search_query %}
<div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
        <i class="fas fa-search"></i> 
        Найдено заказов по запросу "{{ search_query }}": {{ orders|length }}
    </div>
    <a href="{% url 'order_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-times"></i> Сбросить поиск
    </a>
</div>
{% endif %}

<!-- Список заказов -->
<div class="row">
    {% for order in orders %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <a href="{% url 'order_detail' order.id %}" class="text-decoration-none">
                        Заказ №{{ order.order_number }}
                    </a>
                </h5>
                <div>
                    <span class="badge bg-primary">Вес: {{ order.total_weight|floatformat:2 }} кг</span>
                    {% if order.drawing_number %}
                    <span class="badge bg-secondary">Чертеж: {{ order.drawing_number }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-8">
                        <p class="mb-1"><strong>Наименование:</strong></p>
                        <p class="mb-1">{{ order.order_name|truncatechars:50 }}</p>
                    </div>
                    <div class="col-4">
                        <p class="mb-1"><strong>Деталей:</strong></p>
                        <p class="mb-1">{{ order.items.count }} шт.</p>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <p class="mb-1"><strong>Создатель:</strong></p>
                        <p class="mb-1">
                            <i class="fas fa-user"></i> 
                            {{ order.user.last_name }} {{ order.user.first_name|first }}. 
                            {% if order.user.profile.patronymic %}
                                {{ order.user.profile.patronymic|first }}.
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>Дата:</strong></p>
                        <p class="mb-1">{{ order.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <p class="mb-1"><strong>Коэффициент:</strong></p>
                        <p class="mb-1">{{ order.coefficient }}</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>Материалов:</strong></p>
                        <p class="mb-1">{{ order.materials_count }} шт.</p>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'order_detail' order.id %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Подробнее
                    </a>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#copyOrderModal{{ order.id }}">
                        <i class="fas fa-copy"></i> Копировать
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-print"></i> Печать
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="{% url 'print_order_report' order.id %}" target="_blank">
                                    <i class="fas fa-table"></i> Детальный отчет
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'print_grouped_report' order.id %}" target="_blank">
                                    <i class="fas fa-layer-group"></i> Группированный отчет
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{% url 'print_cutting_task' order.id %}" target="_blank">
                                    <i class="fas fa-cut"></i> Задание на заготовку
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-calendar"></i> {{ order.created_at|date:"d.m.Y" }} 
                    <i class="fas fa-user ms-2"></i> {{ order.user.last_name }} {{ order.user.first_name|first }}.
                </small>
            </div>
        </div>
    </div>

    <!-- Модальное окно для копирования заказа -->
    <div class="modal fade" id="copyOrderModal{{ order.id }}" tabindex="-1" aria-labelledby="copyOrderModalLabel{{ order.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyOrderModalLabel{{ order.id }}">
                        <i class="fas fa-copy"></i> Копирование заказа №{{ order.order_number }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'copy_order' order.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Будет создана копия заказа со всеми деталями.
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_order_number{{ order.id }}" class="form-label fw-bold">
                                Номер нового заказа <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                class="form-control" 
                                id="new_order_number{{ order.id }}" 
                                name="new_order_number" 
                                placeholder="Например: 2025-03"
                                required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_order_name{{ order.id }}" class="form-label fw-bold">
                                Наименование нового заказа
                            </label>
                            <input type="text" 
                                class="form-control" 
                                id="new_order_name{{ order.id }}" 
                                name="new_order_name" 
                                value="{{ order.order_name }}">  <!-- Убрано "Копия" -->
                            <div class="form-text">Оставьте поле пустым, чтобы скопировать наименование исходного заказа</div>
                        </div>
                        
                        <div class="bg-light p-3 rounded">
                            <p class="mb-1"><strong>Исходный заказ:</strong></p>
                            <p class="mb-0">Номер: {{ order.order_number }}</p>
                            <p class="mb-0">Наименование: {{ order.order_name }}</p>
                            <p class="mb-0">Деталей: {{ order.items.count }} шт.</p>
                            <p class="mb-0">Вес: {{ order.total_weight|floatformat:2 }} кг</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-copy"></i> Создать копию
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center py-5">
            <i class="fas fa-box-open fa-4x mb-3"></i>
            <h4>Заказы не найдены</h4>
            {% if search_query %}
                <p>По запросу "{{ search_query }}" ничего не найдено</p>
                <a href="{% url 'order_list' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-times"></i> Сбросить поиск
                </a>
            {% else %}
                <p>У вас пока нет заказов</p>
                <a href="{% url 'order_create' %}" class="btn btn-success mt-2">
                    <i class="fas fa-plus"></i> Создать первый заказ
                </a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}